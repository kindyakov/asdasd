"use strict";(self.webpackChunkgulp2023=self.webpackChunkgulp2023||[]).push([[907,829],{1037:(e,t,a)=>{a.d(t,{A:()=>r});var n=a(8868),s=a(182);const r=class{constructor(e,t={}){const a={minRotation:0,maxRotation:0,color:"#64748b",font:{size:14,weight:500,family:"Manrope"}},r={options:{scales:{x:{ticks:a,border:{width:0},grid:{color:"#f3f3f3",lineWidth:1}},y:{ticks:a,grid:{color:"#f3f3f3",lineWidth:1},border:{width:0}}},plugins:{legend:{display:!1},tooltip:{enabled:!1,external:function(e){const{chart:t,tooltip:a}=e,n=t.canvas.parentNode.querySelector(".chart-tooltip");if(!n)return;if(0===a.opacity)return void(n.style.opacity=0);const s=a.dataPoints[0].dataIndex,r=t.data.datasets[0],i=t.data.datasets[1];n.innerHTML=`<div><b style="background: ${r.color};"></b><span>${r.data[s]}</span></div>\n              <div><b style="background: ${i.color};"></b><span>${i.data[s]}</span></div>`,n.style.opacity=1,n.style.left=t.canvas.offsetLeft+a.caretX-n.clientWidth-6+"px",n.style.top=t.canvas.offsetTop+a.caretY-n.clientHeight-6+"px"}}},responsive:!0,maintainAspectRatio:!1}};this.chart=new n.Ay(e,s({},r,t)),window.addEventListener("resize",(()=>this.resizeChart()))}resizeChart(){this.chart&&this.chart.update("resize")}}},6694:(e,t,a)=>{a.d(t,{A:()=>f});var n=a(3282),s=a(4429),r=a(2302),i=a(9706),l=a(1014),d=a(3711),o=a(6047),c=a(2346),h=a(9661),u=a(3943),p=a(2514);class m extends n.A{constructor(e,t,a){const n={columnDefs:[{headerCheckboxSelection:!0,checkboxSelection:!0,width:50,resizable:!1,sortable:!1},{headerName:"Договор",field:"agrid",minWidth:80,flex:.3,cellRenderer:e=>{const t=document.createElement("span");return t.classList.add("table-span-agrid"),t.textContent=e.value?(0,c.H)(e.value):"нет",(0,h.a)(e,{el:t})}},{headerName:"ФИО",field:"fullname",minWidth:300,flex:.8,cellRenderer:e=>(0,h.a)(e,{iconId:"profile"})},{headerName:"Дата платежа",field:"payment_date",minWidth:130,flex:.5,cellRenderer:e=>(0,h.a)(e,{funcFormate:u.p,iconId:"calendar"})},{headerName:"Вид поступления",field:"type",minWidth:100,flex:.5},{headerName:"Статья учета",field:"account_article",minWidth:80,flex:.5},{headerName:"Сумма",field:"amount",minWidth:90,flex:.5,cellRenderer:e=>{const t=document.createElement("span");return t.classList.add("table-span-price"),t.innerHTML=e.value?(0,o.F)(e.value):"нет",(0,h.a)(e,{el:t})}},{headerName:"Сотрудник",field:"manager_name",minWidth:90,flex:.5},{headerName:"Физ./Юр.",field:"user_type",minWidth:90,flex:.5,valueFormatter:e=>"f"===e.value?"Физ. лицо":"Юр. лицо"},{headerName:"Действия",field:"actions",minWidth:80,flex:.5,resizable:!1,sortable:!1,cellRenderer:e=>this.actionCellRenderer(e)}]};super(e,Object.assign({},n,t),Object.assign({},{selectTypeUser:!0,onChangeTypeUser:()=>{}},a)),this.actionCellRenderer=this.actionCellRenderer.bind(this)}actionCellRenderer(e){const{agrid:t,user_type:a,payment_id:n}=e.data,i=e.eGridCell.closest(".ag-row"),l=document.createElement("button");let o;l.classList.add("button-table-actions"),l.innerHTML="<span></span><span></span><span></span><svg class='icon icon-check'><use xlink:href='img/svg/sprite.svg#check'></use></svg>";const c=(0,d.o)(l,{attrModal:"modal-agreement",data:e.data});return c.options.onEdit=e=>{this.validatorRow?.revalidate().then((t=>{if(t){const t=new FormData(o);let a={payment_id:n};t.set("payment_date",(0,u.p)(t.get("payment_date"),"YYYY-MM-DD")),Array.from(t).forEach((e=>a[e[0]]=e[1])),this.editPayment(a).finally((()=>{e.toggleEdit(l),e.isEdit=!1,this.disableEditing(i),this.validatorRow.destroy()}))}}))},c.options.onEnableEdit=()=>{o=document.createElement("form");const e=this.enableEditing(i),t={};e.forEach((e=>{const a=e.cloneNode(!0);a.value=e.value,t[e.name]=e,o.appendChild(a),e.addEventListener("input",(()=>{a.value=e.value,this.validatorRow?.revalidateField(a).then((t=>{e.value=a.value,t?e.classList.remove("just-validate-error-field"):e.classList.add("just-validate-error-field")}))}))})),this.validatorRow=function(e,t={}){if(!e)return;const a=(0,s.f)(e,t),n=(0,r.d)(t.inputsObj.payment_date,{dateFormat:"d.m.Y"});return a.addField(e.querySelector('input[name="payment_date"]'),[{rule:"required"}]).addField(e.querySelector('input[name="amount"]'),[{rule:"required"},{validator:(e,t)=>{const a=t[2].elem;return a.value=e.replace(/[^0-9]/g,""),Number.isInteger(+a.value)}}]).addField(e.querySelector('input[name="fullname"]'),[{rule:"required"},{rule:"customRegexp",value:/^[А-ЯЁа-яё\s]+$/,errorMessage:"Неверный формат"}]).addField(e.querySelector('input[name="agrid"]'),[{rule:"required"},{validator:(e,t)=>{const a=t[4].elem;return a.value=e.replace(/[^0-9]/g,""),Number.isInteger(+a.value)}}]),a.onDestroy=()=>{n.destroy()},a}(o,{inputsObj:t})},l}render(e){const{payments:t,cnt_pages:a,page:n}=e;this.setPage(n,a),this.gridApi.setGridOption("rowData",t),this.gridApi.setGridOption("paginationPageSizeSelector",[5,10,15,20,t.length])}async editPayment(e){try{this.loader.enable();const t=await i.F.post("/_edit_payment_",e);if(200!==t.status)return;(0,p.G)(t.data)}catch(e){console.error(e)}finally{this.loader.disable()}}async download(e){try{this.loader.enable();let t={};if(e.length){const a=e.map((e=>e.payment_id));t.all_payments=0,t.payment_ids=a}else t.all_payments=1;await(0,l.up)(t)}catch(e){console.error(e)}finally{this.loader.disable()}}}const f=m},3711:(e,t,a)=>{a.d(t,{o:()=>r});var n=a(9244);let s={tippyInstance:null,isEdit:!1,buttons:[(e={})=>{const t=document.createElement("button");return t.classList.add("tippy-button","table-tippy-client__button","btn-edit-row-table"),t.innerHTML="\n      <svg class='icon icon-edit'>\n        <use xlink:href='img/svg/sprite.svg#edit'></use>\n      </svg>\n      <span>Редактировать</span>",t},(e={})=>{const t=document.createElement("button");return t.classList.add("tippy-button","table-tippy-client__button","btn-open"),t.innerHTML="\n      <svg class='icon icon-arrow-right-circle' styles=\"fill: none;\">\n        <use xlink:href='img/svg/sprite.svg#arrow-right-circle'></use>\n      </svg>\n      <span>Открыть</span>",t}],onEdit:()=>{},onEnableEdit:()=>{},onOpen:()=>{}};function r(e,t={}){const a=Object.assign({toggleEdit:i,toggleActive:l},s,t),r=(0,n.Ay)(e,{allowHTML:!0,trigger:"click",content:t=>{const n=document.createElement("div");function s(t){t.target.closest(".btn-edit-row-table")&&(i(e),a.isEdit=!0,a.onEnableEdit(a)),a.tippyInstance.hide()}return n.classList.add("tippy","table-tippy-client"),a.buttons.forEach((e=>{const t=e();t.setAttribute("data-json",JSON.stringify(a.data)),t.classList.contains("btn-open")&&t.setAttribute("data-modal",a.attrModal),t.addEventListener("click",s),n.appendChild(t)})),n},maxWidth:180,duration:0,placement:"bottom-start",interactive:!0,appendTo:document.body,onTrigger(e,t){a.tippyInstance=e,a.isEdit&&a.onEdit(a)},onShow(t){if(a.isEdit)return!1;l(e)},onHide(t){l(e)}});function i(e){e.classList.toggle("_edit")}function l(e){e.classList.toggle("_active")}return r.options=a,r}},2346:(e,t,a)=>{function n(e){let t,a;return a=Array.isArray(e)?e:e.split(",").map((e=>e.trim())),t=a.map((e=>`№${e}`)),t.join(", ")}a.d(t,{H:()=>n})},9661:(e,t,a)=>{a.d(t,{a:()=>r});var n=a(2783);const s={funcFormate:e=>e,iconId:null,el:null,inputmode:"text",attributes:[]};function r(e,t={}){const{funcFormate:a,iconId:r,el:i,inputmode:l,attributes:d}=Object.assign({},s,t),o=(0,n.n)("div",["wp-input","wp-input-cell","not-edit"]);let c="";if(i&&(o.classList.add("is-dop-content"),i.classList.add("dop-el-content")),r){const e=`<svg class='icon icon-${r}'><use xlink:href='img/svg/sprite.svg#${r}'></use></svg>`;o.insertAdjacentHTML("afterbegin",e),o.classList.add("is-icon")}return d.length&&(c=d.map((e=>`${e[0]}="${e[1]}"`)).join(" ")),o.insertAdjacentHTML("beforeend",`<input type="text" name="${e.colDef.field}" value="${e.value?a(e.value):""}" class="input-cell cell-input not-edit" autocomplete="off" readonly="true" inputmode="${l}" ${c}>${i?i.outerHTML:""}`),o}},8829:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(6353),s=a(2302),r=a(3943);const i=class{constructor({loader:e,tables:t=[],charts:a=[],page:n}){this.loader=e,this.wrapper=document.querySelector(`[data-content="dashboards/${n}"]`),this.formFilter=this.wrapper.querySelector(".form-filter-dashboards"),this.tables=[],this.charts=[],t.length&&t.forEach((e=>{const{TableComponent:t,tableSelector:a,options:n={},params:s={}}=e;this.table=new t(a,{...n,wrapper:this.wrapper},s),this.tables.push(this.table)})),a.length&&a.forEach((e=>{const{id:t,ChartComponent:a,options:n={}}=e,s=new a(this.wrapper.querySelector(`#${t}`),n);this.charts.push(s)})),this.queryParams={},this.widgets=this.wrapper.querySelectorAll("[data-render-widget]"),this.init(n)}init(e){this.formFilter&&(this.selectFilter=new n.l({uniqueName:"select-filter-main",parentEl:this.wrapper}),this.calendars=(0,s.d)(`[data-content="dashboards/${e}"] .input-date-filter`,{mode:"range",dateFormat:"d. M, Y",onChange:(e,t,a)=>{2===e.length&&this.changeQueryParams({start_date:(0,r.p)(e[0],"YYYY-MM-DD"),end_date:(0,r.p)(e[1],"YYYY-MM-DD")})}})),this.events()}events(){this.tables.length&&this.actionsTables((e=>{e.onPageChange=t=>this.renderTable(e,{page:t}),e.onChangeTypeUser=({e:t,select:a,optionValue:n})=>this.renderTable(e,{user_type:n}),e.onValueInputSearch=t=>{""!==t?this.renderTable(e,{search_str:t}):this.renderTable(e)}})),this.selectFilter&&(this.selectFilter.onChange=(e,t,a)=>{const n=t.getAttribute("data-name"),s={[n]:a};this.changeQueryParams(s)})}changeQueryParams(e){this.queryParams={...this.queryParams,...e},this.renderDashboard(e)}renderWidgets(e){this.widgets.length&&this.widgets.forEach((t=>{const a=t.getAttribute("data-render-widget"),[n,s]=a.split(","),r=e[n]?e[n]+`${s||""}`:"В процессе доработки";e[n]||(t.style.fontSize="16px"),t.innerHTML=r}))}actionsTables(e=(()=>{})){if(!this.tables.length)return console.error("Нет таблиц");this.tables.forEach((t=>{e(t)}))}actionsCharts(e=(()=>{})){this.charts.length&&this.charts.forEach((t=>{e(t)}))}async render(){try{this.loader.enable();const[e,t]=await Promise.all([this.getDashboardData(),this.getData()]);e&&(this.renderWidgets(e),this.actionsCharts((t=>t.render(e)))),this.tables.length&&t&&this.actionsTables((e=>e.render(t)))}catch(e){console.error(e)}finally{this.loader.disable()}}async renderDashboard(e){try{this.loader.enable(),await this.getDashboardData(e)}catch(e){console.error(e)}finally{this.loader.disable()}}async renderTable(e,t={}){try{this.loader.enable();const a=await this.getData(t);e.render(a)}catch(e){console.error(e)}finally{this.loader.disable()}}}},2907:(e,t,a)=>{a.r(t),a.d(t,{default:()=>v});var n=a(8829),s=a(6694),r=a(182),i=a(1037),l=a(6353);function d(e,t,a){const n=[];for(let s=0;s<e;s++)n.push(Math.floor(Math.random()*(a-t+1))+t);return n}class o extends i.A{constructor(e,t){const a={type:"bar",data:{labels:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],datasets:[{label:"Факт",data:d(30,100,1500),backgroundColor:"#3c50e0",color:"#3c50e0",barThickness:6},{label:"План",data:d(30,200,1200),backgroundColor:"#6f7d90",color:"#6f7d90",barThickness:6}]},options:{scales:{y:{ticks:{callback:function(e,t,a){const n=["","тыс","млн","млрд"];let s=0;for(;e>=1e3&&s<n.length-1;)e/=1e3,s++;return e.toFixed(0)+" "+n[s]}}}},plugins:{legend:{position:"top"}}}};super(e,r({},a,t)),this.datasets={plan:()=>{this.chart.data.datasets[0].hidden=!0,this.chart.data.datasets[1].hidden=!1,this.chart.update()},fact:()=>{this.chart.data.datasets[0].hidden=!1,this.chart.data.datasets[1].hidden=!0,this.chart.update()},planFact:()=>{this.chart.data.datasets[0].hidden=!1,this.chart.data.datasets[1].hidden=!1,this.chart.update()}},this.selects=new l.l({uniqueName:"select-chart-monthly-revenue",selectMinWidth:125}),this.selects.onChange=this.handleSelectChange.bind(this)}handleSelectChange(e,t,a){this.datasets[a]&&this.datasets[a]()}render(e){e.length&&(this.chart.data.labels=Array.from({length:e.length},((e,t)=>t+1)),this.chart.data.datasets[0].data=e.map((e=>e.revenue)),this.chart.data.datasets[1].data=e.map((e=>e.revenue_planned)),this.chart.update())}}const c=o;var h=a(1014),u=a(9661),p=a(3943),m=a(6047),f=a(2346),g=a(1169);function b(){const e=new Date,t=e.getFullYear(),a=e.getMonth();return[new Date(t,a,1),new Date(t,a+1,0)]}class y extends n.default{constructor({loader:e}){super({loader:e,tables:[{tableSelector:".table-payments",TableComponent:s.A,options:{columnDefs:[{headerCheckboxSelection:!0,checkboxSelection:!0,width:50,resizable:!1,sortable:!1},{headerName:"Дата платежа",field:"payment_date",minWidth:140,flex:.5,cellRenderer:e=>(0,u.a)(e,{funcFormate:p.p,iconId:"calendar"})},{headerName:"Сумма",field:"amount",minWidth:80,flex:.5,cellRenderer:e=>{const t=document.createElement("span");return t.classList.add("table-span-price"),t.innerHTML=e.value?(0,m.F)(e.value):"нет",(0,u.a)(e,{el:t})}},{headerName:"ФИО",field:"fullname",minWidth:350,flex:1,cellRenderer:e=>(0,u.a)(e,{iconId:"profile"})},{headerName:"Договор",field:"agrid",minWidth:70,flex:.5,cellRenderer:e=>{const t=document.createElement("span");return t.classList.add("table-span-agrid"),t.textContent=e.value?(0,f.H)(e.value):"нет",(0,u.a)(e,{el:t})}},{headerName:"Вид поступления",field:"type",minWidth:90,flex:.5},{headerName:"Физ./Юр.",field:"user_type",minWidth:90,flex:.5,resizable:!1,valueFormatter:e=>"f"===e.value?"Физ. лицо":"Юр. лицо"}]}}],charts:[{id:"chart-monthly-revenue",ChartComponent:c}],page:"finance"})}async getData(e={}){return(0,h.k5)(e)}async getDashboardData(e={}){return Promise.all([(0,h.$f)(e),(0,h.A7)(Object.keys(e).length?e:{start_date:(0,g.R)(b()[0],"yyyy-MM-dd"),end_date:(0,g.R)(b()[1],"yyyy-MM-dd")})])}async render(){try{this.loader.enable();const[e,t]=await Promise.all([this.getDashboardData(),this.getData()]);if(e){const[t=[],{finance_planfact:a=[]}]=e;this.renderWidgets(t),this.actionsCharts((e=>e.render(a)))}this.tables.length&&t&&this.actionsTables((e=>e.render(t)))}catch(e){console.error(e)}finally{this.loader.disable()}}}const v=y},1169:(e,t,a)=>{a.d(t,{R:()=>i});var n=a(4929),s=a(291),r=a(5580);function i(e,t="dd.MM.yyyy"){if(!e)throw new Error("Date is required");if("string"==typeof e&&(e=(0,n.H)(e)),!(e instanceof Date)||isNaN(e))throw new Error("Invalid date");return(0,s.GP)(e,t,{locale:r.ru})}}}]);