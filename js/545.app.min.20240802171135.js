"use strict";(self.webpackChunkgulp2023=self.webpackChunkgulp2023||[]).push([[545,829],{1037:(e,t,a)=>{a.d(t,{A:()=>r});var s=a(8868),n=a(182);const r=class{constructor(e,t={}){const a={minRotation:0,maxRotation:0,color:"#64748b",font:{size:14,weight:500,family:"Manrope"}},r={options:{scales:{x:{ticks:a,border:{width:0},grid:{color:"#f3f3f3",lineWidth:1}},y:{ticks:a,grid:{color:"#f3f3f3",lineWidth:1},border:{width:0}}},plugins:{legend:{display:!1},tooltip:{enabled:!1,external:function(e){const{chart:t,tooltip:a}=e,s=t.canvas.parentNode.querySelector(".chart-tooltip");if(!s)return;if(0===a.opacity)return void(s.style.opacity=0);const n=a.dataPoints[0].dataIndex,r=t.data.datasets[0],i=t.data.datasets[1];s.innerHTML=`<div><b style="background: ${r.color};"></b><span>${r.data[n]}</span></div>\n              <div><b style="background: ${i.color};"></b><span>${i.data[n]}</span></div>`,s.style.opacity=1,s.style.left=t.canvas.offsetLeft+a.caretX-s.clientWidth-6+"px",s.style.top=t.canvas.offsetTop+a.caretY-s.clientHeight-6+"px"}}},responsive:!0,maintainAspectRatio:!1}};this.chart=new s.Ay(e,n({},r,t)),window.addEventListener("resize",(()=>this.resizeChart()))}resizeChart(){this.chart&&this.chart.update("resize")}}},2048:(e,t,a)=>{a.d(t,{A:()=>g});var s=a(1660),n=a(3282),r=a(4429),i=a(9706),o=a(3711),l=a(6047),d=a(9700),c=a(2346),h=a(9661),u=a(2514);class p extends n.A{constructor(e,t,a){const s={columnDefs:[{headerCheckboxSelection:!0,checkboxSelection:!0,width:50,resizable:!1,sortable:!1},{headerName:"ФИО",field:"fullname",minWidth:300,flex:1,cellRenderer:e=>(0,h.a)(e,{iconId:"profile"})},{headerName:"Телефон",field:"username",minWidth:170,flex:.5,cellRenderer:e=>(0,h.a)(e,{funcFormate:l.n})},{headerName:"Почта",field:"email",minWidth:260,flex:.5,sortable:!1,cellRenderer:e=>(0,h.a)(e)},{headerName:"Ячейки",field:"rooms",minWidth:100,flex:.5,valueFormatter:e=>e.value?(0,c.H)(e.value):"нет"},{headerName:"Платеж в мес.",field:"month_payment",minWidth:100,flex:.5,cellRenderer:e=>{const t=document.createElement("span");return t.classList.add("table-span-price"),t.innerHTML=e.value?(0,l.F)(e.value):"нет",t}},{headerName:"До платежа",field:"days_left",minWidth:100,flex:.5,cellRenderer:e=>{const t=document.createElement("p");return t.classList.add("table-p"),t.innerHTML=`\n            <svg class='icon icon-calendar'>\n              <use xlink:href='img/svg/sprite.svg#calendar'></use>\n            </svg>\n            <span>${e.value?`${e.value} ${(0,d.Y)(Math.abs(e.value),["День","Дня","Дней"])}`:"Нет"}</span>`,t}},{headerName:"Действия",field:"actions",width:90,cellRenderer:e=>this.actionCellRenderer(e),resizable:!1,sortable:!1}]};super(e,Object.assign({},s,t),Object.assign({},{selectTypeUser:!1,onChangeTypeUser:()=>{}},a)),this.actionCellRenderer=this.actionCellRenderer.bind(this),this.enableEditing=this.enableEditing.bind(this),this.onChangeTypeUser=this.params.onChangeTypeUser}actionCellRenderer(e){const{user_id:t,user_type:a}=e.data,n=e.eGridCell.closest(".ag-row"),i=document.createElement("button");let l;i.classList.add("button-table-actions"),i.innerHTML="<span></span><span></span><span></span><svg class='icon icon-check'><use xlink:href='img/svg/sprite.svg#check'></use></svg>";const d=(0,o.o)(i,{onOpen:()=>{},attrModal:"modal-client",data:e.data});return d.options.onEdit=e=>{this.validatorRow?.revalidate().then((a=>{if(a){const a=new FormData(l);let s={user_id:t};a.set("username",a.get("username").replace(/[+() -]/g,"")),Array.from(a).forEach((e=>s[e[0]]=e[1])),this.editClient({client:s}).finally((()=>{e.toggleEdit(i),e.isEdit=!1,this.disableEditing(n),this.validatorRow.destroy()}))}}))},d.options.onEnableEdit=()=>{l=document.createElement("form"),this.enableEditing(n).forEach((e=>{const t=e.cloneNode(!0);t.value=e.value,l.appendChild(t),"username"===e.name&&s.default("+7 (999) 999-99-99").mask(e),e.addEventListener("input",(()=>{t.value=e.value,this.validatorRow?.revalidateField(t).then((t=>{t?e.classList.remove("just-validate-error-field"):e.classList.add("just-validate-error-field")}))}))})),this.validatorRow=function(e,t={}){if(!e)return;const a=(0,r.f)(e,t),n=e.querySelector('input[name="username"]');return s.default("+7 (999) 999-99-99").mask(n),a.addField(e.querySelector('input[name="fullname"]'),[{rule:"required",errorMessage:"Введите фио"},{rule:"customRegexp",value:/^[А-ЯЁа-яё\s]+$/,errorMessage:"Неверный формат"}]).addField(n,[{rule:"required",errorMessage:"Введите телефон"},{validator:e=>{const t=s.default.unmask(e,{mask:"+7 (999) 999-99-99"});return Boolean(Number(t)&&10===t.length)},errorMessage:"Неверный формат"}]).addField(e.querySelector('input[name="email"]'),[{rule:"required",errorMessage:"Введите почту"},{rule:"email",errorMessage:"Неверный формат"}]),a}(l)},i}render(e){const{clients:t,cnt_pages:a,page:s}=e;this.setPage(s,a),this.gridApi.setGridOption("rowData",t),this.gridApi.setGridOption("paginationPageSizeSelector",[5,10,15,20,t.length])}async editClient(e){try{this.loader.enable();const t=await i.F.post("/_edit_client_",e);if(200!==t.status)return;(0,u.G)(t.data)}catch(e){console.error(e)}finally{this.loader.disable()}}}const g=p},3711:(e,t,a)=>{a.d(t,{o:()=>r});var s=a(9244);let n={tippyInstance:null,isEdit:!1,buttons:[(e={})=>{const t=document.createElement("button");return t.classList.add("tippy-button","table-tippy-client__button","btn-edit-row-table"),t.innerHTML="\n      <svg class='icon icon-edit'>\n        <use xlink:href='img/svg/sprite.svg#edit'></use>\n      </svg>\n      <span>Редактировать</span>",t},(e={})=>{const t=document.createElement("button");return t.classList.add("tippy-button","table-tippy-client__button","btn-open"),t.innerHTML="\n      <svg class='icon icon-arrow-right-circle' styles=\"fill: none;\">\n        <use xlink:href='img/svg/sprite.svg#arrow-right-circle'></use>\n      </svg>\n      <span>Открыть</span>",t}],onEdit:()=>{},onEnableEdit:()=>{},onOpen:()=>{}};function r(e,t={}){const a=Object.assign({toggleEdit:i,toggleActive:o},n,t),r=(0,s.Ay)(e,{allowHTML:!0,trigger:"click",content:t=>{const s=document.createElement("div");function n(t){t.target.closest(".btn-edit-row-table")&&(i(e),a.isEdit=!0,a.onEnableEdit(a)),a.tippyInstance.hide()}return s.classList.add("tippy","table-tippy-client"),a.buttons.forEach((e=>{const t=e();t.setAttribute("data-json",JSON.stringify(a.data)),t.classList.contains("btn-open")&&t.setAttribute("data-modal",a.attrModal),t.addEventListener("click",n),s.appendChild(t)})),s},maxWidth:180,duration:0,placement:"bottom-start",interactive:!0,appendTo:document.body,onTrigger(e,t){a.tippyInstance=e,a.isEdit&&a.onEdit(a)},onShow(t){if(a.isEdit)return!1;o(e)},onHide(t){o(e)}});function i(e){e.classList.toggle("_edit")}function o(e){e.classList.toggle("_active")}return r.options=a,r}},2346:(e,t,a)=>{function s(e){let t,a;return a=Array.isArray(e)?e:e.split(",").map((e=>e.trim())),t=a.map((e=>`№${e}`)),t.join(", ")}a.d(t,{H:()=>s})},9661:(e,t,a)=>{a.d(t,{a:()=>r});var s=a(2783);const n={funcFormate:e=>e,iconId:null,el:null,inputmode:"text",attributes:[]};function r(e,t={}){const{funcFormate:a,iconId:r,el:i,inputmode:o,attributes:l}=Object.assign({},n,t),d=(0,s.n)("div",["wp-input","wp-input-cell","not-edit"]);let c="";if(i&&(d.classList.add("is-dop-content"),i.classList.add("dop-el-content")),r){const e=`<svg class='icon icon-${r}'><use xlink:href='img/svg/sprite.svg#${r}'></use></svg>`;d.insertAdjacentHTML("afterbegin",e),d.classList.add("is-icon")}return l.length&&(c=l.map((e=>`${e[0]}="${e[1]}"`)).join(" ")),d.insertAdjacentHTML("beforeend",`<input type="text" name="${e.colDef.field}" value="${e.value?a(e.value):""}" class="input-cell cell-input not-edit" autocomplete="off" readonly="true" inputmode="${o}" ${c}>${i?i.outerHTML:""}`),d}},5545:(e,t,a)=>{a.r(t),a.d(t,{default:()=>b});var s=a(8829),n=a(2048),r=a(182),i=a(1037),o=a(3943),l=a(6353);class d extends i.A{constructor(e,t={}){const a=e.getContext("2d").createLinearGradient(0,0,0,400);a.addColorStop(0,"rgba(60, 80, 224, 0.1)"),a.addColorStop(1,"rgba(60, 80, 224, 0.01)");const s={type:"line",data:{labels:["Янв","Фев","Март","Апр","Май","Июнь","Июль","Авг","Сент","Окт","Нояб","Дек"],datasets:[{label:"Приток клиентов (факт)",data:[62,120,180,180,150,100,180,160,160,200,300,280],borderColor:"#3c50e0",fill:!0,color:"#3c50e0",backgroundColor:a,pointRadius:3,pointBackgroundColor:"#fff",borderWidth:2},{label:"Приток клиентов (план)",data:[30,50,32,66,23,64,47,87,23,65,76,64,21,25,14],borderColor:"#6f7d90",color:"#6f7d90",pointRadius:3,pointBackgroundColor:"#fff",borderWidth:2}]},options:{plugins:{afterDraw:e=>{if(e.tooltip._active&&e.tooltip._active.length){const t=e.tooltip._active[0],a=e.ctx,s=t.element.x,n=e.scales.y.top,r=e.scales.y.bottom;a.save(),a.beginPath(),a.setLineDash([5,5]),a.moveTo(s,n),a.lineTo(s,r),a.lineWidth=1,a.strokeStyle="#000",a.stroke(),a.restore()}}},annotation:{annotations:{line:{type:"line",yMin:0,yMax:400,borderColor:"red",backgroundColor:"rgba(255, 99, 132, 0.25)",borderWidth:2,borderDash:[10,5],drawTime:"afterDraw"}}}}};super(e,r({},s,t)),this.datasets={plan:()=>{this.chart.data.datasets[0].hidden=!0,this.chart.data.datasets[1].hidden=!1,this.chart.update()},fact:()=>{this.chart.data.datasets[0].hidden=!1,this.chart.data.datasets[1].hidden=!0,this.chart.update()},planFact:()=>{this.chart.data.datasets[0].hidden=!1,this.chart.data.datasets[1].hidden=!1,this.chart.update()}},this.selects=new l.l({uniqueName:"select-chart-influx-customers",selectMinWidth:125}),this.selects.onChange=this.handleSelectChange.bind(this)}handleSelectChange(e,t,a){this.datasets[a]&&this.datasets[a]()}render(e){const{inflow_by_month:t=[]}=e;t.length&&(this.chart.data.labels=t.map((e=>(0,o.G)(e.month))),this.chart.data.datasets[0].data=t.map((e=>e.cnt)),this.chart.update())}}const c=d;class h extends i.A{constructor(e,t={}){super(e,{type:"bar",data:{labels:["до 18","18-25","25-30","30-35","35-45","от 45"],datasets:[{label:"Мужчины",data:[25,20,35,15,20,25],backgroundColor:"#3c50e0",color:"#3c50e0",barThickness:12},{label:"Женщины",data:[20,28,15,12,18,30],backgroundColor:"#80caed",color:"#80caed",barThickness:12}]},options:{responsive:!0,layout:{height:400},scales:{x:{barPercentage:.1,grid:{display:!1}},y:{grid:{borderDash:[5,5],color:"#e2e8f0"},ticks:{callback:function(e,t,a){return e+"%"}}}},plugins:{legend:{position:"top"}}}})}render(e){const{sex_age_data:t=[]}=e;t.length}}const u=h;var p=a(1014);class g extends s.default{constructor({loader:e}){super({loader:e,tables:[{tableSelector:".table-clients",TableComponent:n.A}],charts:[{id:"chart-influx-customers",ChartComponent:c},{id:"chart-gender-age",ChartComponent:u}],page:"clients"})}async getData(e={}){return(0,p.Lf)(e)}async getDashboardData(){return(0,p.Ob)()}}const b=g},8829:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var s=a(6353),n=a(2302),r=a(3943);const i=class{constructor({loader:e,tables:t=[],charts:a=[],page:s}){this.loader=e,this.wrapper=document.querySelector(`[data-content="dashboards/${s}"]`),this.formFilter=this.wrapper.querySelector(".form-filter-dashboards"),this.tables=[],this.charts=[],t.length&&t.forEach((e=>{const{TableComponent:t,tableSelector:a,options:s={},params:n={}}=e;this.table=new t(a,{...s,wrapper:this.wrapper},n),this.tables.push(this.table)})),a.length&&a.forEach((e=>{const{id:t,ChartComponent:a,options:s={}}=e,n=new a(this.wrapper.querySelector(`#${t}`),s);this.charts.push(n)})),this.queryParams={},this.widgets=this.wrapper.querySelectorAll("[data-render-widget]"),this.init(s)}init(e){this.formFilter&&(this.selectFilter=new s.l({uniqueName:"select-filter-main",parentEl:this.wrapper}),this.calendars=(0,n.d)(`[data-content="dashboards/${e}"] .input-date-filter`,{mode:"range",dateFormat:"d. M, Y",onChange:(e,t,a)=>{2===e.length&&this.changeQueryParams({start_date:(0,r.p)(e[0],"YYYY-MM-DD"),end_date:(0,r.p)(e[1],"YYYY-MM-DD")})}})),this.events()}events(){this.tables.length&&this.actionsTables((e=>{e.onPageChange=t=>this.renderTable(e,{page:t}),e.onChangeTypeUser=({e:t,select:a,optionValue:s})=>this.renderTable(e,{user_type:s}),e.onValueInputSearch=t=>{""!==t?this.renderTable(e,{search_str:t}):this.renderTable(e)}})),this.selectFilter&&(this.selectFilter.onChange=(e,t,a)=>{const s=t.getAttribute("data-name"),n={[s]:a};this.changeQueryParams(n)})}changeQueryParams(e){this.queryParams={...this.queryParams,...e},this.renderDashboard(e)}renderWidgets(e){this.widgets.length&&this.widgets.forEach((t=>{const a=t.getAttribute("data-render-widget"),[s,n]=a.split(","),r=e[s]?e[s]+`${n||""}`:"В процессе доработки";e[s]||(t.style.fontSize="16px"),t.innerHTML=r}))}actionsTables(e=(()=>{})){if(!this.tables.length)return console.error("Нет таблиц");this.tables.forEach((t=>{e(t)}))}actionsCharts(e=(()=>{})){this.charts.length&&this.charts.forEach((t=>{e(t)}))}async render(){try{this.loader.enable();const[e,t]=await Promise.all([this.getDashboardData(),this.getData()]);e&&(this.renderWidgets(e),this.actionsCharts((t=>t.render(e)))),this.tables.length&&t&&this.actionsTables((e=>e.render(t)))}catch(e){console.error(e)}finally{this.loader.disable()}}async renderDashboard(e){try{this.loader.enable(),await this.getDashboardData(e)}catch(e){console.error(e)}finally{this.loader.disable()}}async renderTable(e,t={}){try{this.loader.enable();const a=await this.getData(t);e.render(a)}catch(e){console.error(e)}finally{this.loader.disable()}}}}}]);